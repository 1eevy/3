/*
	Micromagnetic standard problem 2 according to
	http://www.ctcms.nist.gov/~rdm/mumag.org.html.
	Checks against solution from Donahue.
*/

	Ms := 1000e3           // Msat and Aex should not matter
	Msat = Ms
	Aex   = 10e-12

	// exchange length
	lex := sqrt(Aex.GetRegion(0) / (0.5 * mu0 * pow(Msat.GetRegion(0),2)))

	mx := m.comp(0)

	for d := 1; d < 20; d++{

		Sizex := 5*lex*d
		Sizey := 1*lex*d
		Sizez := 0.1*lex*d

		// 5*power-of-two number of cells not larger than 0.75 exchange lengths
		nx := pow(2, ilogb(Sizex / (5*0.75*lex))) * 5
		ny := nx / 5
		if ny < 2{
			nx = 10
			ny = 2  // smallest allowed size
		}

		SetGridSize(nx, ny, 1)
		SetCellSize(Sizex/nx, Sizey/ny, Sizez)

		m = uniform(1, 0.1, 0)
		relax()

		remanence := m.average()
		
		b := 0.01
		for b=0.05*Ms; mx.average() >0; b+=0.0001*Ms{
			B_ext = vector(-b*mu0/sqrt(3), -b*mu0/sqrt(3), -b*mu0/sqrt(3))
			relax()
		}
		B_ext = vector(0, 0, 0)

		fprintln("table.txt", d, remanence.x(), remanence.z(), b/Ms)
		print(d, remanence.x(), remanence.y(), b/Ms)
		
	}

